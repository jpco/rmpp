#!/bin/bash

# How to save what you just killed? Use unrm! :)
# Written by Jack Conger, 2014

# ARGUMENT HANDLING

if [[ $# -eq 0 ]]; then
	echo "unrm: missing operand."
	echo "try 'unrm --help' for more information."
	exit 1
elif [[ $1 = "--help" ]]; then
	echo "Usage: unrm FILE..."
	echo "Unrm: To bring back things which have been sent to the trash by rmpp."
	echo "option --last: To bring back the latest removed thing."
	echo ""
	echo "If you want to use wildcards, put your argument in single quotes ''!"
	echo "Otherwise things won't go well."
	echo ""
	echo "Created by Jack Conger 2014."
	exit 0
fi

wdir=$(pwd)

if [[ $1 = "--last" ]]; then
	lastline=$(tail -1 ~/.trash/trashregister)
	lasttime=${lastline##*~}
	
	while read line; do
		if ! [[ $line =~ $lasttime ]]; then
			continue
		fi
		tounrm=$(echo "$line" | cut -f 1)
		unrm $tounrm
	done < ~/.trash/trashregister

	exit 0
fi

# THE MEAT

for ftounrm in "$@"; do
	cd $(dirname "$ftounrm")
	fullpath=$(pwd)
	justfname="${ftounrm##*/}"
	if [[ -z $justfname ]]; then
		justfname=${ftounrm%?##*/}
		justfname=${justfname%?}
	fi

	echo $"Path: $fullpath/"$justfname
	justfname=$(echo "$justfname" | sed -r "s/\*/\.\*/g")

	filefound=""

	while read -r line; do
		echo "Line: "$line
		target=$(echo $line | cut -d " " -f 1)
		fnameintrash=$(echo $line | cut -d " " -f 2)
		echo "Fname: "$fnameintrash
		if [[ -n $fnameintrash ]]; then
			filefound=1
			rmsuccess=""
			if [[ -d ~/.trash/$fnameintrash ]]; then
				cp -r ~/.trash/$fnameintrash $target && /bin/rm -rf ~/.trash/$fnameintrash && rmsuccess=1
			else
				cp ~/.trash/$fnameintrash $target && /bin/rm -rf ~/.trash/$fnameintrash && rmsuccess=1
			fi
			if [[ -n $rmsuccess ]]; then
				grep -v "^$fullpath/$justfname\>" ~/.trash/trashregister > ~/.trash/newtrashreg
				mv ~/.trash/newtrashreg ~/.trash/trashregister
			fi
		fi
	done < <(grep "^$fullpath/$justfname\>" ~/.trash/trashregister)
	if [[ -z $filefound ]]; then
		echo "File not found in trash."
		cd $wdir
		exit 1
	fi
done

cd $wdir
